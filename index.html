<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Envío de correo (AJAX + PHPMailer)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f7f7f7; }
    .container { max-width: 880px; }
    .spinner-border { display: none; }
    .required::after { content:" *"; color:#dc3545; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="h4 mb-3">Enviar correo</h1>

    <div id="alerta" class="alert d-none" role="alert"></div>

    <form id="formCorreo" enctype="multipart/form-data">
      <div class="row g-3">
        <div class="col-12">
          <label class="form-label required">Para (To)</label>
          <input type="text" name="to" class="form-control" placeholder="correo1@dominio.cl, correo2@dominio.cl" required>
          <small class="text-muted">Separar múltiples correos con coma.</small>
        </div>

        <div class="col-md-6">
          <label class="form-label">CC</label>
          <input type="text" name="cc" class="form-control" placeholder="cc1@dominio.cl, cc2@dominio.cl">
        </div>

        <div class="col-md-6">
          <label class="form-label">BCC</label>
          <input type="text" name="bcc" class="form-control" placeholder="bcc1@dominio.cl, bcc2@dominio.cl">
        </div>

        <div class="col-md-6">
          <label class="form-label required">Asunto</label>
          <input type="text" name="subject" class="form-control" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Nombre remitente (FromName)</label>
          <input type="text" name="from_name" class="form-control" placeholder="Ej: Plataforma Notificaciones">
        </div>

        <div class="col-md-6">
          <label class="form-label">Responder a (Reply-To)</label>
          <input type="email" name="reply_to" class="form-control" placeholder="opcional@dominio.cl">
        </div>

        <div class="col-12">
          <label class="form-label required">Mensaje (HTML permitido)</label>
          <textarea name="message" class="form-control" rows="6" required><b>Hola</b>, esto es una <i>prueba</i>.</textarea>
        </div>

        <div class="col-12">
          <label class="form-label">Adjuntos</label>
          <input type="file" name="attachments[]" class="form-control" multiple>
        </div>

        <div class="col-12 d-flex align-items-center gap-3">
          <button id="btnEnviar" class="btn btn-primary" type="submit">Enviar</button>
          <div class="spinner-border" role="status" id="spinner"></div>
        </div>
      </div>
    </form>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script>
  $(function() {
    var $form = $('#formCorreo');
    var $btn  = $('#btnEnviar');
    var $spin = $('#spinner');
    var $alt  = $('#alerta');

    function esc(s) { return $('<div/>').text(String(s || '')).html(); }

    $form.on('submit', function(e) {
      e.preventDefault();
      $btn.prop('disabled', true); $spin.show();
      $alt.addClass('d-none').removeClass('alert-success alert-danger').html('');

      var fd = new FormData(this);

      $.ajax({
        url: 'send_mail.php',
        method: 'POST',
        data: fd,
        processData: false,
        contentType: false,
        dataType: 'json'
      }).done(function(res) {
        var extra = '';
        if (typeof res.dns_ip !== 'undefined')
          extra += 'DNS → ' + esc(res.dns_ip) + '<br>';
        if (typeof res.port_open !== 'undefined')
          extra += 'Conexión a puerto → ' + (res.port_open ? 'OK' : 'FALLÓ') +
                   (res.errno ? ' (errno ' + esc(res.errno) + ': ' + esc(res.errstr) + ')' : '') + '<br>';
        if (res.error) extra += 'PHPMailer ErrorInfo → ' + esc(res.error) + '<br>';
        if (res.debug) {
          extra += '<details class="mt-2"><summary>Traza SMTP</summary>' +
                   '<pre class="small bg-light p-2 border rounded overflow-auto">' + esc(res.debug) + '</pre></details>';
        }

        if (res && res.success) {
          $alt.removeClass('d-none').addClass('alert alert-success')
              .html('<strong>OK:</strong> ' + esc(res.message || 'Correo enviado.') + '<br>' + extra);
          $form[0].reset();
        } else {
          $alt.removeClass('d-none').addClass('alert alert-danger')
              .html('<strong>Error:</strong> ' + esc((res && res.message) || 'No se pudo enviar.') + '<br>' + extra);
        }
      }).fail(function(xhr) {
        $alt.removeClass('d-none').addClass('alert alert-danger')
            .text('Error de red o del servidor. HTTP ' + xhr.status);
      }).always(function() {
        $btn.prop('disabled', false); $spin.hide();
      });
    });
  });
  </script>
</body>
</html>
